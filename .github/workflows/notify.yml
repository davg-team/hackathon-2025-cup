name: Notify Telegram

on:
  workflow_run:
    workflows:
        - "Build and Deploy Frontend"
        # - "Build and Deploy docs"
        - "Sync Repository Content"
        - "Deploy Serverless Service - users"
        - "Deploy Serverless Service - organizations"
        - "Deploy Serverless Service - files"
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    - name: Determine status
      run: |
        if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
          echo "status=success" >> $GITHUB_ENV
        else
          echo "status=failure" >> $GITHUB_ENV
        fi

    - name: Send Telegram Notification
      run: |
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        if [ "${{ env.status }}" == "success" ]; then
          TEXT="‚úÖ Workflow '${{ github.event.workflow_run.name }}' –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ ${{ github.repository }}.                  üîó [–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º](${{ github.event.workflow_run.html_url }})"
        else
          TEXT="‚ùå Workflow '${{ github.event.workflow_run.name }}' –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ ${{ github.repository }}.                  üîó [–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º](${{ github.event.workflow_run.html_url }})"
        fi

        # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Telegram API
        curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="$TEXT" \
          -d parse_mode="Markdown"
